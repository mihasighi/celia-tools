# Makefile
#
# CELIA Tool / UCONS Domain
#
# Copyright (C) LIAFA 2009-2014

# This file is part of the CELIA tool, released under LGPL license.
# Please read the COPYING file packaged in the distribution.

include ./Makefile.config

PREFIX = ../../..

# C include and lib directories
INCDIR = $(PREFIX)/include
LIBDIR = $(PREFIX)/lib
BINDIR = $(PREFIX)/bin

SRCDIR = $(shell pwd)

#---------------------------------------
# Programs
#---------------------------------------

# Library creation
SHARED = $(CC) -shared

#---------------------------------------
# Flags
#---------------------------------------

# Use ICFLAGS to specify machine-independent compilation flags.
ICFLAGS = \
-I$(MPFR_PREFIX)/include \
-I$(GMP_PREFIX)/include \
-I$(CAML_PREFIX)/lib/ocaml \
-I$(CAMLIDL_PREFIX)/lib/ocaml \
-I$(MLGMPIDL_PREFIX)/include \
-I$(APRON_CCINC) \
-I$(APRON_OCINC) \
-I$(PREFIX)/src/utils \
-I$(PREFIX)/src/shad/shad \
-I$(PREFIX)/src/slad \
-I$(PREFIX)/src/arad/ucons


# Caml
OCAMLINC = \
-I $(MLGMPIDL_PREFIX)/include \
-I $(APRON_PREFIX)/include \
-I $(APRON_PREFIX)/lib 

#---------------------------------------
# Files
#---------------------------------------

CCSOURCES = ucons_print_dot_1.c

CCINC = 

TSTS = $(subst .c,_tst,$(CCSOURCES))

#---------------------------------------
# Rules
#---------------------------------------

root:
	@echo
	@echo "Please choose a target from:"
	@echo
	@echo " all                     : build the C library"
	@echo " alltest                 : run the all tests"
	@echo " indent                  : to indent C sources"
	@echo " clean                   : remove objects"
	@echo " distclean               : clean & uninstall"
	@echo " mostyleclean            : remove objects & autogenerated"
	@echo " rebuild                 : rebuild autogenerated "
	@echo

all: alltest

alltest: $(TSTS)

clean:
	/bin/rm -f *.[ao] *_tst
	/bin/rm -f *.?.tex *.log *.aux *.bbl *.blg *.toc *.dvi *.ps *.pstex*
	/bin/rm -fr *.cm[ioax] *.cmxa
	/bin/rm -fr *~ \#*\# *.BAK f_*.shp

mostlyclean: clean
	/bin/rm -fr *_caml.c *.mli

uninstall:
	/bin/rm -fr $(INCDIR)/lib/libucons*.a

distclean: uninstall
	/bin/rm -f Makefile.depend

indent: $(CCSOURCES) $(CCINC)
	for i in $(CCSOURCES) $(CCINC); do \
		echo "* indent $$i"; indent -bl -i2 -tuc $$i; \
	done

#-----------------------------------
# C part
#-----------------------------------

APRON_LIBS = \
-lapron \
-lboxD \
-loctD \
-lpolkaRll \
-lap_ppl \
-lppl

UCONS_LIBS = -lucons$(DEBUG) \
-lap2sh 

SHARED_LIBS = $(UCONS_LIBS) \
        $(APRON_LIBS) \
	-lmpfr \
	-lgmp \
	-lm

LDFLAGS = -L$(GMP_PREFIX)/lib \
	-L$(MPFR_PREFIX)/lib \
	-L$(APRON_PREFIX)/lib \
	-L$(PREFIX)/lib 

#---------------------------------------
# IMPLICIT RULES AND DEPENDENCIES
#---------------------------------------

.SUFFIXES: .c 


%_tst: %.c 
	$(CC) $(CFLAGS_DEBUG) $(ICFLAGS) $(LDFLAGS) -o $@ $< $(SHARED_LIBS)
	./$@

.PRECIOUS: %_tst

#-----------------------------------
# Caml part
#-----------------------------------


#---------------------------------------
# IDL rules
#---------------------------------------


#---------------------------------------
# ML generic rules
#---------------------------------------

#-----------------------------------
# DEPENDENCIES
#-----------------------------------
