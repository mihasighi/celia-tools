# Makefile
#
# CELIA Tool / UCONS Domain
#
# Copyright (C) LIAFA 2009-2014

# This file is part of the CELIA tool, released under LGPL license.
# Please read the COPYING file packaged in the distribution.

include ./Makefile.config

PREFIX = ../../..

# C include and lib directories
INCDIR = $(PREFIX)/include
LIBDIR = $(PREFIX)/lib
BINDIR = $(PREFIX)/bin

SRCDIR = $(shell pwd)

#---------------------------------------
# Programs
#---------------------------------------

# Library creation
SHARED = $(CC) -shared

#---------------------------------------
# Flags
#---------------------------------------

# Use ICFLAGS to specify machine-independent compilation flags.
ICFLAGS = \
-I$(MPFR_PREFIX)/include \
-I$(GMP_PREFIX)/include \
-I$(CAML_PREFIX)/lib/ocaml \
-I$(CAMLIDL_PREFIX)/lib/ocaml \
-I$(MLGMPIDL_PREFIX)/include \
-I$(APRON_CCINC) \
-I$(APRON_OCINC) \
-I$(PREFIX)/src/utils \
-I$(PREFIX)/src/shad/shad \
-I$(PREFIX)/src/slad


# Caml
OCAMLINC = \
-I $(MLGMPIDL_PREFIX)/include \
-I $(APRON_PREFIX)/include \
-I $(APRON_PREFIX)/lib 

#---------------------------------------
# Files
#---------------------------------------

ADOM_CCSOURCES = adom_print.c adom_transfer.c adom_closure.c adom_nary.c \
	adom_representation.c adom_predicate.c adom_resize.c

ADOM_CCINC = adom.h adom_internal.h adom_fun.h 

UCONS_CCSOURCES = $(subst adom,ucons,$(ADOM_CCSOURCES)) \
		ucons_internal_resize.c ucons_resize_succ_P12.c assertions.c

UCONS_CCINC = $(subst adom,ucons,$(ADOM_CCINC))
	    
CCSOURCES = $(UCONS_CCSOURCES) 

CCINC = $(UCONS_CCINC) 

# trigers a whole recompilation
#DEPS = $(APRON_PREFIX)/include/ap_abstract0.h

#---------------------------------------
# Rules
#---------------------------------------

root:
	@echo
	@echo "Please choose a target from:"
	@echo
	@echo " all                     : build the C library"
	@echo " install                 : to install what has been compiled"
	@echo " alltest                 : run the all tests"
	@echo " indent                  : to indent C sources"
	@echo " clean                   : remove objects"
	@echo " distclean               : clean & uninstall"
	@echo " mostyleclean            : remove objects & autogenerated"
	@echo " rebuild                 : rebuild autogenerated "
	@echo

all: UCl
ifeq ($(DEBUG),_debug)
	ln -f -s libucons$(DEBUG).so libucons.so
endif

UCl: libucons$(DEBUG).so

alltest: uconstest

clean:
	/bin/rm -f *.[ao] uconstest
	/bin/rm -f *.?.tex *.log *.aux *.bbl *.blg *.toc *.dvi *.ps *.pstex*
	/bin/rm -fr *.cm[ioax] *.cmxa
	/bin/rm -fr *~ \#*\# *.BAK f_*.shp

mostlyclean: clean
	/bin/rm -fr *_caml.c *.mli

#TODO: (un)install other dynlib also
install:
	mv libucons*.* $(LIBDIR)

uninstall:
	/bin/rm -fr $(LIBDIR)/libucons*.a

distclean: uninstall
	/bin/rm -f Makefile.depend

indent: $(CCSOURCES) $(CCINC)
	for i in $(CCSOURCES) $(CCINC); do \
		echo "* indent $$i"; indent -bl -i2 -tuc $$i; \
	done

#-----------------------------------
# C part
#-----------------------------------

APRON_LIBS = \
-lapron \
-lboxD \
-loctD \
-lpolkaRll \
-lap_ppl \
-lppl

SHARED_LIBS = $(APRON_LIBS) \
	-lmpfr \
	-lgmp \
	-lm

LDFLAGS = -L$(GMP_PREFIX)/lib \
	-L$(MPFR_PREFIX)/lib \
	-L$(APRON_PREFIX)/lib \
	-L$(LIBDIR)/lib

# ucons_*
#
libucons.a: $(subst .c,.o,$(UCONS_CCSOURCES))
	$(AR) rcs $@ $^
	$(RANLIB) $@

libucons_debug.a: $(subst .c,_debug.o,$(UCONS_CCSOURCES))
	$(AR) rcs $@ $^
	$(RANLIB) $@

libucons.so: $(subst .c,.o,$(UCONS_CCSOURCES))
	$(SHARED) $(LDFLAGS) $(SHARED_LIBS) -o $@ $^

libucons_debug.so: $(subst .c,_debug.o,$(UCONS_CCSOURCES))
	$(SHARED) $(LDFLAGS) $(SHARED_LIBS) -o $@ $^

uconstest: libucons_debug.a ucons_test_debug.o
	$(CC) $(CFLAGS_DEBUG) $(ICFLAGS) -o $@ ucons_test_debug.o \
	$(LDFLAGS) \
	-lucons_debug $(SHARED_LIBS)


#---------------------------------------
# IMPLICIT RULES AND DEPENDENCIES
#---------------------------------------

.SUFFIXES: .tex .c .h .a .o .so .y .l


%_caml.o: %_caml.c $(CCINC) $(DEPS) lib%.a
	$(CC) $(CFLAGS) $(ICFLAGS) -c -o $@ $<

%.o: %.c $(CCINC) $(DEPS)
	$(CC) $(CFLAGS) $(ICFLAGS) -c -o $@ $<

%_debug.o: %.c $(CCINC) $(DEPS)
	$(CC) $(CFLAGS_DEBUG) $(ICFLAGS) -c -o $@ $<

.PRECIOUS: libucons%.a 


#-----------------------------------
# Caml part
#-----------------------------------


#---------------------------------------
# IDL rules
#---------------------------------------


#---------------------------------------
# ML generic rules
#---------------------------------------

#-----------------------------------
# DEPENDENCIES
#-----------------------------------
